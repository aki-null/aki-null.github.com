
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Memory Management Issues with GCD - Nullified Construction</title>
  <meta name="author" content="Akihiro Noguchi">

  
  <meta name="description" content="I have been using GCD quite extensively on my desktop application, and have noticed severe memory management issue. The battle started when I have &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://aki-null.github.com/blog/2009/10/08/memory-management-issues-with-gcd">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Nullified Construction" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <h1><a href="/">Nullified Construction</a></h1>
  
    <h2>Random stuff I do</h2>
  
</hgroup>

</header>
  <nav role="navigation">
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:aki-null.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Memory Management Issues With GCD</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-10-08T00:00:00+11:00" pubdate data-updated="true">Oct 8<span>th</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I have been using GCD quite extensively on my desktop application, and have noticed severe memory management issue. The battle started when I have realised a strange memory usage increase when the application was ran overnight without any user interaction. The memory usage of the application was about 70MB before I went to bed. When I got up, the memory usage was on 400MB. This was unexpected, because I was always making sure that there are no memory leaks in my application using Instruments.</p>

<p>I was trying to come up with a valid explanation of this issue to fix the bug. I have profiled the objects in the memory using the command line tool “heap” that was apparently introduced on Snow Leopard. However, I could not find significant issue after running it for an hour.</p>

<p>I could not figure out what was wrong for the entire day, so I restarted the program before I went to bed last night, and profiled the objects in the memory. When I got up this morning, the memory usage was on 400MB as expected. I ran the profiler again, and it told me that there were insane amount of objects that were not being freed. This was unusual, because Instruments told me that there were no leaks. I have fiddled with the application for a while, and ran the profiler again. I was extremely surprised when I saw the new report generated by the heap tool. All objects that were not being freed were all gone! At this point, I’ve realised that this was not happening to the build that did not have GCD optimisation.</p>

<p>After a while, I found out that it was indeed caused by GCD optimisation code I wrote. I ran some tests, and realised that objects that were allocated in Blocks dispatched to main queue are not being released UNTIL something triggers the NSAutoreleasePool to drain. This means the auto-released objects allocated inside a Block that was dispatched to the main queue are not released until a user interaction occurs.</p>

<pre><code>dispatch_async(dispatch_get_global_queue(0, 0), ^{
    // do something expensive
    dispatch_async(dispatch_get_main_queue(), ^{
        // All auto-released objects allocated
        // in here are not released until the
        // next event loop fires.
    });
});
</code></pre>

<p>The above code should explain what was going on. I ran several tests to validate that my hypothesis was correct. To fix the problem, I have changed the above code to the following code.</p>

<pre><code>dispatch_async(dispatch_get_global_queue(0, 0), ^{
    // do something expensive
    dispatch_async(dispatch_get_main_queue(), ^{
        NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
        // all auto-released objects are released when
        // this block finishes!
        [pool drain];
    });
});
</code></pre>

<p>After placing the NSAutoreleasePool inside a block dispatched to the main queue, everything was back to normal.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (Akihiro Noguchi)" rel="author">Akihiro Noguchi</a></span></span>

      








  


<time datetime="2009-10-08T00:00:00+11:00" pubdate data-updated="true">Oct 8<span>th</span>, 2009</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://aki-null.github.com/blog/2009/10/08/memory-management-issues-with-gcd/" data-via="aki" data-counturl="http://aki-null.github.com/blog/2009/10/08/memory-management-issues-with-gcd/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2009/10/06/fast-and-thread-safe-singleton-for-objective-c/" title="Previous Post: Fast and Thread-safe Singleton for Objective-C">&laquo; Fast and Thread-safe Singleton for Objective-C</a>
      
      
        <a class="basic-alignment right" href="/blog/2009/10/14/grand-central-dispatch-part-2/" title="next Post: Grand Central Dispatch (Part 2)">Grand Central Dispatch (Part 2) &raquo;</a>
      
    </p>
  </footer>
</article>

</div>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Akihiro Noguchi -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
